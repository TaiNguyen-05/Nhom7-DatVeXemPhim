{% extends 'base.html' %}
{% block title %}Chọn ghế - {{ show_time.movie.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/all_templates.css">
<link rel="stylesheet" href="/static/css/booking-responsive.css">
<link rel="stylesheet" href="/static/css/mobile-optimizations.css">
<link rel="stylesheet" href="/static/css/booking-extras.css">
{% endblock %}

{% block content %}
<div class="container-fluid py-2">
  <!-- Compact Header -->
  <div class="compact-header mb-3">
    <div class="row align-items-center">
      <div class="col-md-2 col-sm-3 col-4">
        {% if show_time.movie.poster %}
        <img src="{{ show_time.movie.poster.url }}" class="img-fluid rounded" alt="{{ show_time.movie.title }}" />
        {% else %}
        <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="height: 60px">
          <i class="fas fa-film fa-lg text-muted"></i>
        </div>
        {% endif %}
      </div>
      <div class="col-md-10 col-sm-9 col-8">
        <div class="row">
          <div class="col-md-3 col-sm-6">
            <h6 class="mb-1 text-primary">{{ show_time.movie.title }}</h6>
            <p class="mb-1 small">
              <i class="fas fa-map-marker-alt me-1 text-danger"></i>
              <strong>{{ show_time.screen.cinema.name }}</strong>
            </p>
          </div>
          <div class="col-md-3 col-sm-6">
            <p class="mb-1 small">
              <i class="fas fa-calendar me-1 text-info"></i>
              {{ show_time.date|date:"d/m/Y" }}
            </p>
            <p class="mb-1 small">
              <i class="fas fa-clock me-1 text-warning"></i>
              {{ show_time.time|time:"H:i" }}
            </p>
          </div>
          <div class="col-md-3 col-sm-6">
            <p class="mb-1 small">
              <i class="fas fa-door-open me-1 text-success"></i>
              {{ show_time.screen.name }}
            </p>
            <p class="mb-1 small">
              <i class="fas fa-clock me-1 text-info"></i>
              {{ show_time.movie.duration }} phút
            </p>
          </div>
          <div class="col-md-3 col-sm-6">
            <p class="mb-1 small">
              <i class="fas fa-ticket-alt me-1 text-success"></i>
              <strong class="text-success">{{ show_time.price|floatformat:0 }} VNĐ/vé</strong>
            </p>
            <div class="rating-compact">
              <i class="fas fa-star text-warning"></i>
              <span class="small">{{ show_time.movie.rating }}/5.0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="row">
    <!-- Left Column - Seat Selection -->
    <div class="col-lg-8 col-md-12">
      <!-- Compact Tabs -->
      <div class="compact-tabs mb-3">
        <div class="card">
          <div class="card-header p-2">
            <ul class="nav nav-pills nav-fill" id="compactTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active btn-sm" id="seats-tab" data-bs-toggle="pill" data-bs-target="#seats">
                  <i class="fas fa-chair me-1"></i>Chọn ghế
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link btn-sm" id="details-tab" data-bs-toggle="pill" data-bs-target="#details">
                  <i class="fas fa-info-circle me-1"></i>Chi tiết
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link btn-sm" id="trailer-tab" data-bs-toggle="pill" data-bs-target="#trailer">
                  <i class="fab fa-youtube me-1"></i>Trailer
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link btn-sm" id="reviews-tab" data-bs-toggle="pill" data-bs-target="#reviews">
                  <i class="fas fa-star me-1"></i>Đánh giá
                </button>
              </li>
            </ul>
          </div>
          <div class="card-body p-3">
            <div class="tab-content" id="compactTabsContent">
              <!-- Tab 1: Seat Selection -->
              <div class="tab-pane fade show active" id="seats" role="tabpanel">
                <!-- Compact Screen -->
                <div class="compact-screen text-center mb-3">
                  <div class="screen-compact">
                    <i class="fas fa-tv me-2"></i>MÀN HÌNH
                  </div>
                </div>

                <!-- Compact Seats Grid -->
                <div class="compact-seats-section">
                  <form method="post" id="booking-form">
                    {% csrf_token %}
                    <div id="selected-seats-inputs"></div>
                    
                    <div class="seats-grid-compact">
                      {% for seat in seats %}
                      <div class="seat-compact {% if seat.status == 'booked' %}booked{% else %}available{% endif %}"
                           data-seat-id="{{ seat.id }}"
                           data-seat-number="{{ seat.seat_number }}"
                           data-seat-status="{{ seat.status }}"
                           {% if seat.status != "booked" %}onclick="toggleSeat(this)"{% endif %}>
                        {{ seat.seat_number }}
                      </div>
                      {% endfor %}
                    </div>

                    <!-- Compact Legend -->
                    <div class="compact-legend mt-3">
                      <div class="row text-center">
                        <div class="col-md-4 col-sm-6 col-12">
                          <div class="legend-item-compact">
                            <div class="legend-seat-compact available">A1</div>
                            <span class="small">Còn trống</span>
                          </div>
                        </div>
                        <div class="col-md-4 col-sm-6 col-12">
                          <div class="legend-item-compact">
                            <div class="legend-seat-compact selected">B2</div>
                            <span class="small">Đã chọn</span>
                          </div>
                        </div>
                        <div class="col-md-4 col-sm-6 col-12">
                          <div class="legend-item-compact">
                            <div class="legend-seat-compact booked">C3</div>
                            <span class="small">Đã đặt</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Action Button -->
                    <div class="text-center mt-3">
                      <button type="submit" class="btn btn-primary btn-lg px-5" id="book-button" disabled>
                        <i class="fas fa-ticket-alt me-2"></i>Đặt vé ngay
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Tab 2: Movie Details -->
              <div class="tab-pane fade" id="details" role="tabpanel">
                <div class="compact-details">
                  <div class="row">
                    <div class="col-md-8">
                      <h6 class="text-primary mb-2">Thông tin phim</h6>
                      <p class="small text-muted mb-3">{{ show_time.movie.description|default:"Thông tin chi tiết về phim sẽ được cập nhật sớm nhất." }}</p>
                      
                      <!-- Compact Info Grid -->
                      <div class="info-grid-compact">
                        <div class="info-item-compact">
                          <i class="fas fa-tag text-warning"></i>
                          <span><strong>Thể loại:</strong> {{ show_time.movie.genre.name }}</span>
                        </div>
                        <div class="info-item-compact">
                          <i class="fas fa-clock text-info"></i>
                          <span><strong>Thời lượng:</strong> {{ show_time.movie.duration }} phút</span>
                        </div>
                        <div class="info-item-compact">
                          <i class="fas fa-calendar-alt text-success"></i>
                          <span><strong>Ngày phát hành:</strong> {{ show_time.movie.release_date|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item-compact">
                          <i class="fas fa-star text-warning"></i>
                          <span><strong>Đánh giá:</strong> {{ show_time.movie.rating }}/5.0</span>
                        </div>
                      </div>

                      <!-- Compact Cast -->
                      <div class="compact-cast mt-3">
                        <h6 class="text-primary mb-2">Diễn viên & Đạo diễn</h6>
                        <div class="cast-grid-compact">
                          <div class="cast-item-compact">
                            <div class="cast-avatar-compact">
                              <i class="fas fa-user"></i>
                            </div>
                            <div class="cast-info-compact">
                              <strong>Đạo diễn</strong>
                              <small>Thông tin sẽ cập nhật</small>
                            </div>
                          </div>
                          <div class="cast-item-compact">
                            <div class="cast-avatar-compact">
                              <i class="fas fa-user"></i>
                            </div>
                            <div class="cast-info-compact">
                              <strong>Diễn viên chính</strong>
                              <small>Thông tin sẽ cập nhật</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4 text-center">
                      <!-- Compact Rating -->
                      <div class="rating-compact-display mb-3">
                        <div class="rating-circle-compact">
                          <span class="rating-number-compact">{{ show_time.movie.rating }}</span>
                        </div>
                        <div class="rating-stars-compact">
                          {% for i in "12345" %}
                            {% if forloop.counter <= show_time.movie.rating %}
                              <i class="fas fa-star text-warning"></i>
                            {% else %}
                              <i class="far fa-star text-muted"></i>
                            {% endif %}
                          {% endfor %}
                        </div>
                      </div>
                      
                      <!-- Compact Actions -->
                      <div class="compact-actions">
                        <button class="btn btn-outline-primary btn-sm mb-2 w-100" onclick="addToWishlist()">
                          <i class="fas fa-heart me-1"></i>Yêu thích
                        </button>
                        <button class="btn btn-outline-info btn-sm mb-2 w-100" onclick="shareMovie()">
                          <i class="fas fa-share me-1"></i>Chia sẻ
                        </button>
                        <a href="{% url 'booking_info' show_time.movie.id %}" class="btn btn-outline-success btn-sm w-100">
                          <i class="fas fa-clock me-1"></i>Suất chiếu khác
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Tab 3: Trailer -->
              <div class="tab-pane fade" id="trailer" role="tabpanel">
                <div class="compact-trailer">
                  {% if show_time.movie.trailer_url %}
                  <div class="trailer-container-compact mb-3">
                    <iframe 
                      src="{{ show_time.movie.trailer_url }}" 
                      width="100%" 
                      height="300" 
                      frameborder="0" 
                      allowfullscreen
                      class="trailer-iframe-compact">
                    </iframe>
                  </div>
                  {% else %}
                  <div class="no-trailer-compact text-center py-4">
                    <i class="fab fa-youtube fa-3x text-muted mb-2"></i>
                    <h6 class="text-muted">Trailer chưa có sẵn</h6>
                  </div>
                  {% endif %}
                  
                  <!-- Compact Related Videos -->
                  <div class="related-videos-compact">
                    <h6 class="text-primary mb-2">Video liên quan</h6>
                    <div class="row">
                      <div class="col-md-4">
                        <div class="video-thumbnail-compact">
                          <i class="fas fa-play-circle fa-2x"></i>
                          <small>Behind the Scenes</small>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="video-thumbnail-compact">
                          <i class="fas fa-play-circle fa-2x"></i>
                          <small>Cast Interview</small>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="video-thumbnail-compact">
                          <i class="fas fa-play-circle fa-2x"></i>
                          <small>Making Of</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Tab 4: Reviews -->
              <div class="tab-pane fade" id="reviews" role="tabpanel">
                <div class="compact-reviews">
                  <div class="reviews-header-compact mb-3">
                    <div class="row align-items-center">
                      <div class="col-md-6">
                        <h6 class="text-primary mb-0">Đánh giá từ khán giả</h6>
                      </div>
                      <div class="col-md-6 text-end">
                        <button class="btn btn-primary btn-sm" onclick="showReviewForm()">
                          <i class="fas fa-plus me-1"></i>Viết đánh giá
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Compact Review Stats -->
                  <div class="review-stats-compact mb-3">
                    <div class="row text-center">
                      <div class="col-md-3 col-sm-6">
                        <div class="stat-item-compact">
                          <div class="stat-number-compact">{{ show_time.movie.rating }}</div>
                          <div class="stat-label-compact">Điểm TB</div>
                        </div>
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <div class="stat-item-compact">
                          <div class="stat-number-compact">0</div>
                          <div class="stat-label-compact">Tổng đánh giá</div>
                        </div>
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <div class="stat-item-compact">
                          <div class="stat-number-compact">0</div>
                          <div class="stat-label-compact">5 sao</div>
                        </div>
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <div class="stat-item-compact">
                          <div class="stat-number-compact">0</div>
                          <div class="stat-label-compact">1 sao</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Compact Reviews List -->
                  <div class="reviews-list-compact">
                    <div class="no-reviews-compact text-center py-4">
                      <i class="fas fa-comments fa-2x text-muted mb-2"></i>
                      <h6 class="text-muted">Chưa có đánh giá nào</h6>
                      <p class="small text-muted">Hãy là người đầu tiên đánh giá phim này!</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Compact Summary -->
    <div class="col-lg-4 col-md-12">
      <div class="compact-summary-sidebar">
        <!-- Compact Booking Summary -->
        <div class="card mb-3">
          <div class="card-header bg-primary text-white p-2">
            <h6 class="mb-0">
              <i class="fas fa-receipt me-2"></i>Tóm tắt đặt vé
            </h6>
          </div>
          <div class="card-body p-3">
            <!-- Compact Movie Info -->
            <div class="summary-compact mb-3">
              <h6 class="text-primary mb-2">{{ show_time.movie.title }}</h6>
              <div class="summary-details-compact">
                <div class="summary-row-compact">
                  <i class="fas fa-calendar text-info"></i>
                  <span>{{ show_time.date|date:"d/m/Y" }} {{ show_time.time|time:"H:i" }}</span>
                </div>
                <div class="summary-row-compact">
                  <i class="fas fa-map-marker-alt text-danger"></i>
                  <span>{{ show_time.screen.cinema.name }}</span>
                </div>
                <div class="summary-row-compact">
                  <i class="fas fa-door-open text-success"></i>
                  <span>{{ show_time.screen.name }}</span>
                </div>
              </div>
            </div>

            <hr class="my-3">

            <!-- Compact Selection Summary -->
            <div class="selection-compact">
              <div class="d-flex justify-content-between mb-2">
                <span class="small">Ghế đã chọn:</span>
                <span id="ticket-count" class="badge bg-primary">0</span>
              </div>
              <div id="selected-seats" class="text-success small mb-3"></div>
              
              <div class="d-flex justify-content-between mb-2">
                <span class="small">Giá vé:</span>
                <span class="small">{{ show_time.price|floatformat:0 }} VNĐ</span>
              </div>
            </div>

            <!-- Compact Total Amount -->
            <div class="total-compact mt-3">
              <div class="price-highlight-compact">
                <div class="small text-white-50">Tổng tiền:</div>
                <div id="total-amount" class="fs-5 fw-bold">0 VNĐ</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Compact Quick Tips -->
        <div class="card mb-3">
          <div class="card-header bg-info text-white p-2">
            <h6 class="mb-0">
              <i class="fas fa-lightbulb me-2"></i>Mẹo nhỏ
            </h6>
          </div>
          <div class="card-body p-3">
            <ul class="tips-list-compact small mb-0">
              <li>Chọn ghế ở giữa để có góc nhìn tốt nhất</li>
              <li>Đặt vé sớm để có nhiều lựa chọn</li>
              <li>Kiểm tra thông tin trước khi thanh toán</li>
            </ul>
          </div>
        </div>

        <!-- Compact Booking History -->
        <div class="card">
          <div class="card-header bg-secondary text-white p-2">
            <h6 class="mb-0">
              <i class="fas fa-history me-2"></i>Lịch sử đặt vé
            </h6>
          </div>
          <div class="card-body p-3">
            <div class="booking-history-compact">
              <div class="no-history-compact text-center py-3">
                <i class="fas fa-ticket-alt fa-2x text-muted mb-2"></i>
                <p class="small text-muted mb-0">Chưa có lịch sử đặt vé</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Review Form Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Viết đánh giá</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="reviewForm">
          <div class="mb-3">
            <label class="form-label">Đánh giá của bạn</label>
            <div class="rating-input">
              <i class="far fa-star" data-rating="1"></i>
              <i class="far fa-star" data-rating="2"></i>
              <i class="far fa-star" data-rating="3"></i>
              <i class="far fa-star" data-rating="4"></i>
              <i class="far fa-star" data-rating="5"></i>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Nhận xét</label>
            <textarea class="form-control" rows="4" placeholder="Chia sẻ cảm nhận của bạn về phim..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="submitReview()">Gửi đánh giá</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/booking-responsive.js"></script>
<script src="/static/js/booking-extras.js"></script>
<script>
  $(document).ready(function() {
    let selectedSeats = [];
    const pricePerTicket = {{ show_time.price }};
    const maxSeats = 10; // Giới hạn số ghế tối đa

    function updateBookingSummary() {
      const count = selectedSeats.length;
      const total = count * pricePerTicket;

      $('#ticket-count').text(count);
      $('#total-amount').text(total.toLocaleString() + ' VNĐ');

      if (count > 0) {
        $('#book-button').prop('disabled', false);
        $('#book-button').removeClass('btn-secondary').addClass('btn-primary');
      } else {
        $('#book-button').prop('disabled', true);
        $('#book-button').removeClass('btn-primary').addClass('btn-secondary');
      }
    }

    function updateSelectedSeatsDisplay() {
      const seatsList = selectedSeats.map(seat => seat.number).join(', ');
      $('#selected-seats').text(seatsList || 'Chưa chọn ghế nào');
      
      // Cập nhật hidden inputs
      const inputsContainer = $('#selected-seats-inputs');
      inputsContainer.empty();
      
      selectedSeats.forEach(seat => {
        inputsContainer.append(`<input type="hidden" name="seats" value="${seat.id}">`);
      });
    }

    function showNotification(message, type = 'info') {
      // Tạo notification đơn giản
      const alertClass = type === 'error' ? 'alert-danger' : type === 'warning' ? 'alert-warning' : 'alert-info';
      const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
          <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `);
      
      $('body').append(notification);
      
      // Tự động ẩn sau 5 giây
      setTimeout(() => {
        notification.alert('close');
      }, 5000);
    }

    window.toggleSeat = function(seatElement) {
      const seatId = $(seatElement).data('seat-id');
      const seatNumber = $(seatElement).data('seat-number');
      const seatStatus = $(seatElement).data('seat-status');

      // Kiểm tra trạng thái ghế
      if (seatStatus === 'booked') {
        showNotification('Ghế này đã được đặt!', 'warning');
        return;
      }

      if ($(seatElement).hasClass('selected')) {
        // Bỏ chọn ghế
        $(seatElement).removeClass('selected');
        selectedSeats = selectedSeats.filter(seat => seat.id !== seatId);
      } else {
        // Kiểm tra giới hạn số ghế
        if (selectedSeats.length >= maxSeats) {
          showNotification(`Chỉ được chọn tối đa ${maxSeats} ghế!`, 'warning');
          return;
        }
        
        // Chọn ghế
        $(seatElement).addClass('selected');
        selectedSeats.push({id: seatId, number: seatNumber});
      }

      updateBookingSummary();
      updateSelectedSeatsDisplay();
    };

    // Khởi tạo hiển thị
    updateSelectedSeatsDisplay();
    
    // Form validation
    $('#booking-form').on('submit', function(e) {
      if (selectedSeats.length === 0) {
        e.preventDefault();
        showNotification('Vui lòng chọn ít nhất một ghế!', 'error');
        return false;
      }
      
      // Kiểm tra xem có ghế nào bị đặt trong lúc chọn không
      const hasBookedSeats = selectedSeats.some(seat => {
        const seatElement = $(`.seat-compact[data-seat-id="${seat.id}"]`);
        return seatElement.hasClass('booked');
      });
      
      if (hasBookedSeats) {
        e.preventDefault();
        showNotification('Có ghế đã bị đặt trong lúc chọn. Vui lòng chọn lại!', 'error');
        return false;
      }
      
      // Hiển thị loading
      $('#book-button').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...');
    });

    // Các function khác
    window.addToWishlist = function() {
      showNotification('Đã thêm vào danh sách yêu thích!', 'info');
    };

    window.shareMovie = function() {
      if (navigator.share) {
        navigator.share({
          title: '{{ show_time.movie.title }}',
          text: 'Xem phim {{ show_time.movie.title }} tại rạp {{ show_time.screen.cinema.name }}',
          url: window.location.href
        });
      } else {
        // Fallback cho trình duyệt không hỗ trợ Web Share API
        navigator.clipboard.writeText(window.location.href);
        showNotification('Đã sao chép link vào clipboard!', 'info');
      }
    };

    window.showReviewForm = function() {
      $('#reviewModal').modal('show');
    };

    window.submitReview = function() {
      showNotification('Chức năng đánh giá sẽ được cập nhật sớm!', 'info');
      $('#reviewModal').modal('hide');
    };
  });
</script>
{% endblock %}
