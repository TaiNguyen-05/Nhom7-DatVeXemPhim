{% extends 'base.html' %}
{% block title %}Admin Dashboard - MovieBooking{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0">
          <i class="fas fa-tachometer-alt me-3"></i>Admin Dashboard
        </h2>
        <div class="d-flex gap-2">
          <a href="{% url 'admin:index' %}" class="btn btn-outline-primary">
            <i class="fas fa-cog me-2"></i>Quản trị
          </a>
          <a href="{% url 'home' %}" class="btn btn-outline-secondary">
            <i class="fas fa-home me-2"></i>Trang chủ
          </a>
        </div>
      </div>
      <p class="text-muted mt-2">Quản lý và theo dõi hệ thống đặt vé xem phim</p>
    </div>
  </div>

  <!-- Thống kê tổng quan -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                Tổng số phim
              </div>
              <div class="h5 mb-0 font-weight-bold text-white">{{ total_movies }}</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-film fa-2x text-primary"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                Tổng đặt vé
              </div>
              <div class="h5 mb-0 font-weight-bold text-white">{{ total_bookings }}</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-ticket-alt fa-2x text-success"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                Người dùng
              </div>
              <div class="h5 mb-0 font-weight-bold text-white">{{ total_users }}</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-users fa-2x text-info"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                Đặt vé hôm nay
              </div>
              <div class="h5 mb-0 font-weight-bold text-white">{{ today_bookings }}</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-calendar-day fa-2x text-warning"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Thống kê chi tiết -->
  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 font-weight-bold text-white">
            <i class="fas fa-chart-line me-2"></i>Thống kê đặt vé theo tháng
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            {% for stat in monthly_stats %}
            <div class="col-md-2 col-4 mb-3">
              <div class="card bg-gradient-primary text-white text-center">
                <div class="card-body py-3">
                  <h4 class="mb-1">{{ stat.count }}</h4>
                  <small>Tháng {{ stat.month }}</small>
                </div>
              </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-4">
              <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
              <p class="text-muted">Chưa có dữ liệu thống kê</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-white">
            <i class="fas fa-chart-pie me-2"></i>Trạng thái thanh toán
          </h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="text-success">Đã thanh toán</span>
              <span class="text-white">{{ paid_bookings }}</span>
            </div>
            <div class="progress mb-3" style="height: 8px;">
              <div class="progress-bar bg-success" style="width: {{ paid_percentage }}%"></div>
            </div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="text-info">Đang xử lý</span>
              <span class="text-white">{{ processing_bookings }}</span>
            </div>
            <div class="progress mb-3" style="height: 8px;">
              <div class="progress-bar bg-info" style="width: {{ processing_percentage }}%"></div>
            </div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="text-warning">Chờ thanh toán</span>
              <span class="text-white">{{ pending_bookings }}</span>
            </div>
            <div class="progress mb-3" style="height: 8px;">
              <div class="progress-bar bg-warning" style="width: {{ pending_percentage }}%"></div>
            </div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="text-secondary">Hết hạn</span>
              <span class="text-white">{{ expired_bookings }}</span>
            </div>
            <div class="progress mb-3" style="height: 8px;">
              <div class="progress-bar bg-secondary" style="width: {{ expired_percentage }}%"></div>
            </div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="text-primary">Đã hoàn tiền</span>
              <span class="text-white">{{ refunded_bookings }}</span>
            </div>
            <div class="progress mb-3" style="height: 8px;">
              <div class="progress-bar bg-primary" style="width: {{ refunded_percentage }}%"></div>
            </div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="text-danger">Đã hủy</span>
              <span class="text-white">{{ cancelled_bookings }}</span>
            </div>
            <div class="progress mb-3" style="height: 8px;">
              <div class="progress-bar bg-danger" style="width: {{ cancelled_percentage }}%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Đặt vé gần đây -->
  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
      <h6 class="m-0 font-weight-bold text-white">
        <i class="fas fa-clock me-2"></i>Đặt vé gần đây
      </h6>
      <a href="{% url 'admin:booking_booking_changelist' %}" class="btn btn-sm btn-primary">
        <i class="fas fa-list me-1"></i>Xem tất cả
      </a>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-dark">
            <tr>
              <th>Người dùng</th>
              <th>Phim</th>
              <th>Suất chiếu</th>
              <th>Ghế</th>
              <th>Tổng tiền</th>
              <th>Trạng thái</th>
              <th>Ngày đặt</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody>
            {% for booking in recent_bookings %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                    <i class="fas fa-user text-white"></i>
                  </div>
                  <div>
                    <div class="fw-bold">{{ booking.user.username }}</div>
                    <small class="text-muted">{{ booking.user.email }}</small>
                  </div>
                </div>
              </td>
              <td>
                <div class="fw-bold">{{ booking.show_time.movie.title }}</div>
                <small class="text-muted">{{ booking.show_time.movie.genre.name }}</small>
              </td>
              <td>
                <div class="fw-bold">{{ booking.show_time.date|date:"d/m/Y" }}</div>
                <small class="text-muted">{{ booking.show_time.time|time:"H:i" }}</small>
              </td>
              <td>
                <span class="badge bg-secondary">{{ booking.seats.count }} ghế</span>
              </td>
              <td>
                <span class="fw-bold text-success">{{ booking.total_amount|floatformat:0 }} VNĐ</span>
              </td>
              <td>
                {% if booking.payment_status == 'paid' %}
                  <span class="badge bg-success">
                    <i class="fas fa-check me-1"></i>Đã thanh toán
                  </span>
                {% elif booking.payment_status == 'pending' %}
                  <span class="badge bg-warning">
                    <i class="fas fa-clock me-1"></i>Chờ thanh toán
                  </span>
                {% else %}
                  <span class="badge bg-danger">
                    <i class="fas fa-times me-1"></i>Đã hủy
                  </span>
                {% endif %}
              </td>
              <td>
                <div class="text-muted">
                  <i class="fas fa-calendar me-1"></i>{{ booking.booking_date|date:"d/m/Y" }}
                </div>
                <small class="text-muted">{{ booking.booking_date|time:"H:i" }}</small>
              </td>
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-cog"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="updateBookingStatus({{ booking.id }}, 'paid')">
                      <i class="fas fa-check text-success me-2"></i>Đã thanh toán thành công
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateBookingStatus({{ booking.id }}, 'pending')">
                      <i class="fas fa-clock text-warning me-2"></i>Chờ xử lý
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateBookingStatus({{ booking.id }}, 'cancelled')">
                      <i class="fas fa-times text-danger me-2"></i>Đã hủy
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'admin:booking_booking_change' booking.id %}">
                      <i class="fas fa-edit text-primary me-2"></i>Chỉnh sửa chi tiết
                    </a></li>
                  </ul>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">Chưa có đặt vé nào</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Phim hot và thống kê khác -->
  <div class="row">
    <div class="col-lg-6">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-white">
            <i class="fas fa-fire me-2"></i>Phim đang hot
          </h6>
        </div>
        <div class="card-body">
          {% for movie in hot_movies %}
          <div class="d-flex align-items-center mb-3">
            {% if movie.poster %}
            <img src="{{ movie.poster.url }}" alt="{{ movie.title }}" class="rounded me-3" style="width: 50px; height: 70px; object-fit: cover;">
            {% else %}
            <div class="bg-secondary rounded me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 70px;">
              <i class="fas fa-film text-muted"></i>
            </div>
            {% endif %}
            <div class="flex-grow-1">
              <div class="fw-bold">{{ movie.title }}</div>
              <div class="text-muted small">{{ movie.views_count }} lượt xem</div>
            </div>
            <div class="text-warning">
              <i class="fas fa-star"></i>
              <span>{{ movie.rating }}/5</span>
            </div>
          </div>
          {% empty %}
          <p class="text-muted text-center">Chưa có phim nào được đánh dấu hot</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-white">
            <i class="fas fa-users me-2"></i>Người dùng mới
          </h6>
        </div>
        <div class="card-body">
          {% for user in recent_users %}
          <div class="d-flex align-items-center mb-3">
            <div class="avatar-sm bg-info rounded-circle d-flex align-items-center justify-content-center me-3">
              <i class="fas fa-user text-white"></i>
            </div>
            <div class="flex-grow-1">
              <div class="fw-bold">{{ user.user.username }}</div>
              <div class="text-muted small">{{ user.user.email }}</div>
            </div>
            <div class="text-muted small">
              {{ user.created_at|date:"d/m/Y" }}
            </div>
          </div>
          {% empty %}
          <p class="text-muted text-center">Chưa có người dùng mới</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.table {
  background-color: #000000 !important;
}
.border-left-primary {
  border-left: 4px solid #e50914 !important;
}
.border-left-success {
  border-left: 4px solid #28a745 !important;
}
.border-left-info {
  border-left: 4px solid #17a2b8 !important;
}
.border-left-warning {
  border-left: 4px solid #ffc107 !important;
}
.avatar-sm {
  width: 40px;
  height: 40px;
}
.bg-gradient-primary {
  background: linear-gradient(135deg, #e50914, #b2070f);
}
</style>

<script>
function updateBookingStatus(bookingId, status) {
  if (confirm('Bạn có chắc chắn muốn thay đổi trạng thái đơn hàng này?')) {
    fetch(`/admin-dashboard/booking/${bookingId}/update-status/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        status: status
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Cập nhật giao diện
        location.reload();
      } else {
        alert('Có lỗi xảy ra: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Có lỗi xảy ra khi cập nhật trạng thái');
    });
  }
}
</script>
{% endblock %} 